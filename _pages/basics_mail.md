---
title: "Mail System"
layout: single
permalink: /basics/mail/
toc: true
toc_label: "Table of Contents"
toc_sticky: true
breadcrumbs: true
---

## Introduction

To follow this tutorial, we will start from the base project created through the [**Getting Started**](https://ontimize.github.io/ontimize-boot/getting_started/). Once we have such a project, we can follow one of these options:

<br>
<div class="doubleColumnRow">
  <div class="doubleColumn" >
      <a href="https://www.ontimize.com/xwiki/bin/view/Ontimize+Boot+Training/Creating+DAO%2C+Service%2C+Controller">Create Service Candidates</a>
      <br>
      <br>
      This tutorial focuses on creating from scratch a Candidates Service database table, DAO, service and controller so that they can be consumed via a REST request.
   
</div>
  <div class="doubleColumn" >
    <a href="https://www.ontimize.com/xwiki/bin/view/Ontimize+Boot+Training/">Ontimize Boot Training</a>
    <br>
    <br>
    Ontimize Boot is a framework that allows you to simplify the configuration of a project made with Ontimize EE, in a fast and efficient way. In this complete tutorial, we are going to create a backend for an application from scratch, including the database with different tables.
  
  </div>
  </div>
  <br>

With the Candidate table and the Candidate service created, we can continue with this tutorial.

## Configuring email service with Ontimize Boot

The Ontimize Boot email service allows you to send mail from the server with a simple configuration. The interface that implements this service is **com.ontimize.jee.common.services.mail.IMailService**.

### BD configuration

If the configuration table does not exist in the DB, it can be created with the following command:

**Sentencia SQL (HSQL)**

```yaml
CREATE TABLE TSETTING(ID_SETTING INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,SETTING_KEY LONGVARCHAR,SETTING_VALUE LONGVARCHAR,SETTING_COMMENTLONGVARCHAR);
```

We fill in this table with the data that applies to each specific mail server, in this example, we will use the following:

| SETTING_KEY     | SETTING_VALUE                                        | SETTING_COMMENT      |
| --------------- | ---------------------------------------------------- | -------------------- |
| mail_host       | smtp.gmail.com                                       | Server host          |
| mail_port       | 587                                                  | Email server port    |
| mail_protocol   | smtp                                                 | Mailing protocol     |
| mail_user       | my.mail@example.com                                  | User for sending     |
| mail_password   | my_password                                          | Mail server password |
| mail-encoding   | UTF-8                                                | Encoding of mails    |
| mail_properties | mail.smtp.auth:true; mail.smtp.starttls.enable:true; | Mail properties      |

**Sentencia SQL (HSQL)**

```yaml
INSERT INTO TSETTING (SETTING_KEY, SETTING_VALUE, SETTING_COMMENT) VALUES('mail_host', 'smtp.gmail.com', 'Server host');
INSERT INTO TSETTING (SETTING_KEY, SETTING_VALUE, SETTING_COMMENT) VALUES('mail_port', '587', 'Email server port');
INSERT INTO TSETTING (SETTING_KEY, SETTING_VALUE, SETTING_COMMENT) VALUES('mail_protocol', 'smtp', 'Mailing protocol');
INSERT INTO TSETTING (SETTING_KEY, SETTING_VALUE, SETTING_COMMENT) VALUES('mail_user', 'my.mail@example.com', 'User for sending');
INSERT INTO TSETTING (SETTING_KEY, SETTING_VALUE, SETTING_COMMENT) VALUES('mail_password', 'my_password', 'Mail server password');
INSERT INTO TSETTING (SETTING_KEY, SETTING_VALUE, SETTING_COMMENT) VALUES('mail_encoding', 'UTF-8', 'Encoding of mails');
INSERT INTO TSETTING (SETTING_KEY, SETTING_VALUE, SETTING_COMMENT) VALUES('mail_properties', 'mail.smtp.auth:true;mail.smtp.starttls.enable:true;', 'Mail properties');
```

The implementation interface contains multiple methods, to which we must give permissions, if our application has permissions:

**Sentencia SQL (HSQL)**

```yaml
INSERT INTO TSERVER_PERMISSION (PERMISSION_NAME) VALUES('com.ontimize.jee.common.services.mail.IMailService/sendMail');
INSERT INTO TSERVER_PERMISSION (PERMISSION_NAME) VALUES('com.ontimize.jee.common.services.mail.IMailService/sendMailWithoutAttach');
INSERT INTO TROLE_SERVER_PERMISSION (ID_ROLENAME, ID_SERVER_PERMISSION) VALUES((SELECT ID_ROLENAME FROM TROLE WHERE ROLENAME='admin'), (SELECT ID_SERVER_PERMISSION FROM TSERVER_PERMISSION WHERE PERMISSION_NAME='com.ontimize.jee.common.services.mail.IMailService/sendMail'));
INSERT INTO TROLE_SERVER_PERMISSION (ID_ROLENAME, ID_SERVER_PERMISSION) VALUES((SELECT ID_ROLENAME FROM TROLE WHERE ROLENAME='admin'), (SELECT ID_SERVER_PERMISSION FROM TSERVER_PERMISSION WHERE PERMISSION_NAME='com.ontimize.jee.common.services.mail.IMailService/sendMailWithoutAttach'));
```

### Server Configuration

To configure this service, a new configuration fragment shall be added to the **application.yml** file.

```yaml
    ontimize:
   mail:
      refRepository: OCSettingsDao
      filterColumnName: SETTING_KEY
      valueColumnName: SETTING_VALUE
      queryId: default
      filterColumnValueEncoding: mail_encoding
      filterColumnValueHost: mail_host
      filterColumnValuePort: mail_port
      filterColumnValueProtocol: mail_protocol
      filterColumnValueUser: mail_user
      filterColumnValuePassword: mail_password
      filterColumnValueJavaMailProperties: mail_properties
      engine: default
```

This configuration indicates the keys and values to be stored in the database. The database table is the one corresponding to the bean described in the **refRepository: OCSettingsDao** attribute (in this case, OCSettingsDao), which can be seen in the table "TSETTING" attribute (for this example, TSETTING) of the \*.xml configuration file of the bean (OCSettingsDao.xml). The keys would be stored in the SETTING_KEY column, the values in the SETTING_VALUE column and the rest of the attributes map the keys that exist in the database.

In addition, the packet that will be scanned to look for the implementation of the email service is indicated.

### Creation of DAO files

Let's create a DAO (Data Access Object) in the projectwiki-model module to use as a model of this database table. The DAO is composed by 2 files, a file with extension _.xml and a _.java file.

<div class="doubleColumnRow">
  <div class="doubleColumn jstreeloader" >
  <ul>
  <li data-jstree='{"opened":true, "icon":"fas fa-folder-open"}'>
  ontimize-examples
  <ul>
    <li data-jstree='{"icon":"fas fa-folder-open"}'>
    api
    <ul>
      <li data-jstree='{"icon":"fas fa-folder-open"}'>
      src
      <ul>
        <li data-jstree='{"icon":"fas fa-folder-open"}'>
        main
        <ul>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          java
          <ul>
            <li data-jstree='{"icon":"fas fa-folder-open"}'>
            api
            <ul>
              <li data-jstree='{"icon":"fas fa-folder-open"}'>
              core
              <ul>
                <li data-jstree='{"icon":"fas fa-folder-open"}'>
                service
                <ul>
                  <li data-jstree='{"icon":"fas fa-file"}'>ICandidateService.java</li>
                  <li data-jstree='{"icon":"fas fa-file"}'>IUserService.java</li>
                </ul>
                </li>
              </ul>
              </li>
            </ul>
            </li>
          </ul>
          </li>
        </ul>
        </li>
      </ul>
      </li>
      <li data-jstree='{"icon":"fas fa-file"}'>pom.xml</li>
    </ul>
    </li>
    <li data-jstree='{"icon":"fas fa-folder-open"}'>
    boot
    <ul>
      <li data-jstree='{"icon":"fas fa-folder-open"}'>
      src
      <ul>
        <li data-jstree='{"icon":"fas fa-folder-open"}'>
        main
        <ul>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          java
          <ul>
            <li data-jstree='{"icon":"fas fa-folder-open"}'>
            boot
            <ul>
              <li data-jstree='{"icon":"fas fa-folder-open"}'>
              core
              <ul>
                <li data-jstree='{"icon":"fas fa-file"}'>ServerApplication.java</li>
              </ul>
              </li>
            </ul>
            </li>
          </ul>
          </li>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          resources
          <ul>
            <li data-jstree='{"icon":"fas fa-file"}'>application.yml</li>
          </ul>
          </li>
        </ul>
        </li>
      </ul>
      </li>
      <li data-jstree='{"icon":"fas fa-file"}'>pom.xml</li>
    </ul>
    </li>
    <li data-jstree='{"icon":"fas fa-folder-open"}'>
    model
    <ul>
      <li data-jstree='{"icon":"fas fa-folder-open"}'>
      src
      <ul>
        <li data-jstree='{"icon":"fas fa-folder-open"}'>
        main
        <ul>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          db
          <ul>
            <li data-jstree='{"icon":"fas fa-file"}'>templateDB.lck</li>
            <li data-jstree='{"icon":"fas fa-file"}'>templateDB.log</li>
            <li data-jstree='{"icon":"fas fa-file"}'>templateDB.properties</li>
            <li data-jstree='{"icon":"fas fa-file"}'>templateDB.script</li>
            <li data-jstree='{"icon":"fas fa-file"}'>templateDB.txt</li>
          </ul>
          </li>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          java
          <ul>
            <li data-jstree='{"icon":"fas fa-folder-open"}'>
            model
            <ul>
              <li data-jstree='{"icon":"fas fa-folder-open"}'>
              core
              <ul>
                <li data-jstree='{"icon":"fas fa-folder-open"}'>
                dao
                <ul>
                  <li data-jstree='{"icon":"fas fa-file"}'>CandidateDao.java</li>
                  <li data-jstree='{"icon":"fas fa-file"}'>OCSettingsDao.java</li>
                  <li data-jstree='{"icon":"fas fa-file"}'>UserDao.java</li>
                  <li data-jstree='{"icon":"fas fa-file"}'>UserRoleDao.java</li>
                </ul>
                </li>
                <li data-jstree='{"icon":"fas fa-folder-open"}'>
                service
                <ul>
                  <li data-jstree='{"icon":"fas fa-file"}'>CandidateService.java</li>
                  <li data-jstree='{"icon":"fas fa-file"}'>UserService.java</li>
                </ul>
                </li>
              </ul>
              </li>
            </ul>
            </li>
          </ul>
          </li>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          resources
          <ul>
            <li data-jstree='{"icon":"fas fa-folder-open"}'>
            dao
            <ul>
              <li data-jstree='{"icon":"fas fa-file"}'>CandidateDao.xml</li>
              <li data-jstree='{"icon":"fas fa-file"}'>OCSettingsDao.xml</li>
              <li data-jstree='{"icon":"fas fa-file"}'>placeholders.properties</li>
              <li data-jstree='{"icon":"fas fa-file"}'>RoleDao.xml</li>
              <li data-jstree='{"icon":"fas fa-file"}'>RoleServerPermissionDao.xml</li>
              <li data-jstree='{"icon":"fas fa-file"}'>ServerPermissionDao.xml</li>
              <li data-jstree='{"icon":"fas fa-file"}'>UserDao.xml</li>
              <li data-jstree='{"icon":"fas fa-file"}'>UserRoleDao.xml</li>
            </ul>
            </li>
          </ul>
          </li>
        </ul>
        </li>
      </ul>
      </li>
      <li data-jstree='{"icon":"fas fa-file"}'>pom.xml</li>
    </ul>
    </li>
    <li data-jstree='{"icon":"fas fa-folder-open"}'>
    ws
    <ul>
      <li data-jstree='{"icon":"fas fa-folder-open"}'>
      src
      <ul>
        <li data-jstree='{"icon":"fas fa-folder-open"}'>
        main
        <ul>
          <li data-jstree='{"icon":"fas fa-folder-open"}'>
          java
          <ul>
            <li data-jstree='{"icon":"fas fa-folder-open"}'>
            ws
            <ul>
              <li data-jstree='{"icon":"fas fa-folder-open"}'>
              core
              <ul>
                <li data-jstree='{"icon":"fas fa-folder-open"}'>
                rest
                <ul>
                  <li data-jstree='{"icon":"fas fa-file"}'>CandidateRestController.java</li>
                  <li data-jstree='{"icon":"fas fa-file"}'>MainRestController.java</li>
                  <li data-jstree='{"icon":"fas fa-file"}'>TestRestController.java</li>
                  <li data-jstree='{"icon":"fas fa-file"}'>UserRestController.java</li>
                </ul>
                </li>
              </ul>
              </li>
            </ul>
            </li>
          </ul>
          </li>
        </ul>
        </li>
      </ul>
      </li>
      <li data-jstree='{"icon":"fas fa-file"}'>pom.xml</li>
    </ul>
    </li>
    <li data-jstree='{"icon":"fas fa-file"}'>.gitignore</li>
    <li data-jstree='{"icon":"fas fa-file"}'>pom.xml</li>
    <li data-jstree='{"icon":"fas fa-file"}'>README.md</li>
  </ul>
  </li>
</ul>
  </div>
  <div class="doubleColumn" >
    {{ "In our *.xml file we will indicate the database table for which DAO belongs, the data source from which we collect the information (i.e. the database connection that contains this table) and the schema to which the table belongs." | markdownify }}

    {{ "**OCSettingsDao.xml**" | markdownify }}   
{% highlight xml linenos%}
<?xml version="1.0" encoding="UTF-8"?>
<JdbcEntitySetup
    xmlns="http://www.ontimize.com/schema/jdbc"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.ontimize.com/schema/jdbc http://www.ontimize.com/schema/jdbc/ontimize-jdbc-dao.xsd"
    catalog="" schema="${mainschema}" table="TSETTING"
    datasource="mainDataSource" sqlhandler="dbSQLStatementHandler">
    <DeleteKeys>
        <Column>ID_SETTING</Column>
    </DeleteKeys>
    <UpdateKeys>
        <Column>ID_SETTING</Column>
    </UpdateKeys>
    <GeneratedKey>ID_SETTING</GeneratedKey>
</JdbcEntitySetup>
{% endhighlight %}

  </div>
</div>
